<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#000000" />
    <meta
      name="description"
      content="Real-time data visualization with React, GraphQL subscriptions, and D3"
    />
    <title>Real-Time Data Viz</title>
    <style>
      body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
          'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue',
          sans-serif;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        background-color: #f5f5f5;
      }
      
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }
      
      .header {
        background-color: #4a90e2;
        color: white;
        padding: 20px;
        text-align: center;
        border-radius: 8px;
        margin-bottom: 20px;
      }
      
      .content {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      
      h1, h2 {
        margin-top: 0;
      }
      
      .spinner {
        border: 4px solid rgba(0, 0, 0, 0.1);
        width: 36px;
        height: 36px;
        border-radius: 50%;
        border-left-color: #09f;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      .success-icon {
        color: #4CAF50;
        font-size: 24px;
        margin-right: 10px;
      }
      
      .error-icon {
        color: #F44336;
        font-size: 24px;
        margin-right: 10px;
      }
      
      .status-line {
        display: flex;
        align-items: center;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <noscript>You need to enable JavaScript to run this app.</noscript>
    <div class="container">
      <div class="header">
        <h1>Real-Time Data Visualization</h1>
      </div>
      <div class="content">
        <h2>Application Status</h2>
        <div id="status">
          <div class="spinner"></div>
          <p>Loading application...</p>
        </div>
        
        <div id="root" style="display: none;">
          <p>The full React application will be available soon.</p>
          <p>In the meantime, you can access the GraphQL API at <a href="/graphql">/graphql</a>.</p>
        </div>
        
        <div id="rest-api-section" style="margin-top: 30px; display: none;">
          <h2>REST API Data</h2>
          <p>Use these controls to fetch data from the REST API after the GraphQL subscription stream ends:</p>
          
          <div style="margin: 20px 0; display: flex; gap: 10px; flex-wrap: wrap;">
            <div>
              <label for="category-select">Category:</label>
              <select id="category-select" style="margin-left: 5px; padding: 5px;">
                <option value="">All Categories</option>
                <option value="Category A">Category A</option>
                <option value="Category B">Category B</option>
                <option value="Category C">Category C</option>
                <option value="Category D">Category D</option>
              </select>
            </div>
            
            <div>
              <label for="limit-input">Limit:</label>
              <input type="number" id="limit-input" value="10" min="1" max="100" style="width: 60px; margin-left: 5px; padding: 5px;">
            </div>
            
            <button id="fetch-data-btn" style="padding: 5px 10px; background-color: #4a90e2; color: white; border: none; cursor: pointer;">
              Fetch Data
            </button>
          </div>
          
          <div id="rest-data-results" style="margin-top: 20px;">
            <p>No data fetched yet. Click the button above to fetch data from the REST API.</p>
          </div>
          
          <div style="margin-top: 30px; border-top: 1px solid #eee; padding-top: 20px;">
            <h3>Add New Data Point via REST API</h3>
            <p>Use this form to add a new data point after streaming ends:</p>
            
            <form id="add-data-form" style="margin-top: 15px;">
              <div style="display: flex; flex-direction: column; gap: 15px; max-width: 500px;">
                <div style="display: flex; flex-direction: column; gap: 5px;">
                  <label for="add-value">Value:</label>
                  <input 
                    id="add-value" 
                    type="number" 
                    step="0.01"
                    style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;"
                    required
                  >
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 5px;">
                  <label for="add-label">Label:</label>
                  <input 
                    id="add-label" 
                    type="text"
                    style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;"
                    required
                  >
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 5px;">
                  <label for="add-category">Category:</label>
                  <select 
                    id="add-category"
                    style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;"
                    required
                  >
                    <option value="">Select a category</option>
                    <option value="Category A">Category A</option>
                    <option value="Category B">Category B</option>
                    <option value="Category C">Category C</option>
                    <option value="Category D">Category D</option>
                  </select>
                </div>
                
                <button 
                  type="submit" 
                  style="padding: 10px; background-color: #4a90e2; color: white; border: none; border-radius: 4px; cursor: pointer;"
                >
                  Add Data Point
                </button>
              </div>
            </form>
            
            <div id="add-result" style="margin-top: 15px;"></div>
          </div>
        </div>
      </div>
    </div>
    
    <script>
      // Simple script to check if the GraphQL server is running
      async function checkServerStatus() {
        const statusDiv = document.getElementById('status');
        try {
          const response = await fetch('/graphql', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              query: `
                query {
                  getDataPoints {
                    id
                    value
                  }
                }
              `
            })
          });
          
          const data = await response.json();
          
          if (data && !data.errors) {
            statusDiv.innerHTML = `
              <div class="status-line">
                <span class="success-icon">✓</span>
                <span>GraphQL Server is running!</span>
              </div>
              <div class="status-line">
                <span class="success-icon">✓</span>
                <span>Data points available: ${data.data.getDataPoints.length}</span>
              </div>
              <div class="status-line">
                <span class="success-icon">✓</span>
                <span>REST API is available at <code>/api/data</code></span>
              </div>
              <p>You can now explore the GraphQL API at <a href="/graphql">/graphql</a>.</p>
              <p>This is a placeholder page. The full React application with D3 visualizations is under development.</p>
            `;
            document.getElementById('root').style.display = 'block';
            document.getElementById('rest-api-section').style.display = 'block';
          } else {
            throw new Error('GraphQL server error');
          }
        } catch (error) {
          statusDiv.innerHTML = `
            <div class="status-line">
              <span class="error-icon">✗</span>
              <span>Error connecting to GraphQL Server</span>
            </div>
            <p>Error details: ${error.message}</p>
            <p>Please check the server logs for more information.</p>
          `;
        }
      }
      
      // Function to fetch data from the REST API
      async function fetchDataFromRestApi() {
        const resultsDiv = document.getElementById('rest-data-results');
        const categorySelect = document.getElementById('category-select');
        const limitInput = document.getElementById('limit-input');
        const fetchButton = document.getElementById('fetch-data-btn');
        
        // Show loading state
        resultsDiv.innerHTML = '<div class="spinner"></div><p>Fetching data...</p>';
        fetchButton.disabled = true;
        
        try {
          // Build URL with query parameters
          let url = '/api/data';
          const params = new URLSearchParams();
          
          if (limitInput.value) {
            params.append('limit', limitInput.value);
          }
          
          if (categorySelect.value) {
            params.append('category', categorySelect.value);
          }
          
          // Add query parameters to URL if there are any
          if ([...params.entries()].length > 0) {
            url += `?${params.toString()}`;
          }
          
          // Make the request
          const response = await fetch(url);
          
          // Check if response is OK
          if (!response.ok) {
            throw new Error(`Error fetching data: ${response.status} ${response.statusText}`);
          }
          
          // Parse JSON response
          const result = await response.json();
          
          // Format timestamp
          const formatTimestamp = (timestamp) => {
            return new Date(timestamp).toLocaleString();
          };
          
          // Display the results in a table
          let tableHtml = '';
          if (result.data && result.data.length > 0) {
            tableHtml = `
              <h3>Found ${result.data.length} data points</h3>
              <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse;">
                  <thead>
                    <tr>
                      <th style="background-color: #f2f2f2; padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd;">ID</th>
                      <th style="background-color: #f2f2f2; padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd;">Label</th>
                      <th style="background-color: #f2f2f2; padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd;">Value</th>
                      <th style="background-color: #f2f2f2; padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd;">Category</th>
                      <th style="background-color: #f2f2f2; padding: 12px 15px; text-align: left; border-bottom: 1px solid #ddd;">Timestamp</th>
                    </tr>
                  </thead>
                  <tbody>
            `;
            
            result.data.forEach(point => {
              tableHtml += `
                <tr>
                  <td style="padding: 12px 15px; border-bottom: 1px solid #ddd;">${point.id}</td>
                  <td style="padding: 12px 15px; border-bottom: 1px solid #ddd;">${point.label}</td>
                  <td style="padding: 12px 15px; border-bottom: 1px solid #ddd;">${point.value}</td>
                  <td style="padding: 12px 15px; border-bottom: 1px solid #ddd;">${point.category}</td>
                  <td style="padding: 12px 15px; border-bottom: 1px solid #ddd;">${formatTimestamp(point.timestamp)}</td>
                </tr>
              `;
            });
            
            tableHtml += `
                  </tbody>
                </table>
              </div>
              <div style="font-size: 12px; color: #666; margin-top: 10px; text-align: right;">
                Last fetched: ${new Date().toLocaleString()}
              </div>
            `;
          } else {
            tableHtml = `<p>No data found matching your criteria.</p>`;
          }
          
          resultsDiv.innerHTML = tableHtml;
        } catch (error) {
          resultsDiv.innerHTML = `
            <div class="status-line">
              <span class="error-icon">✗</span>
              <span>Error fetching data from REST API</span>
            </div>
            <p>Error details: ${error.message}</p>
          `;
        } finally {
          fetchButton.disabled = false;
        }
      }
      
      // Function to add a new data point via REST API
      async function addDataPoint(event) {
        event.preventDefault();
        
        const valueInput = document.getElementById('add-value');
        const labelInput = document.getElementById('add-label');
        const categorySelect = document.getElementById('add-category');
        const resultDiv = document.getElementById('add-result');
        const submitButton = event.target.querySelector('button[type="submit"]');
        
        // Validate form
        if (!valueInput.value || !labelInput.value || !categorySelect.value) {
          resultDiv.innerHTML = `
            <div class="status-line">
              <span class="error-icon">✗</span>
              <span>Please fill in all fields</span>
            </div>
          `;
          return;
        }
        
        // Show loading state
        resultDiv.innerHTML = '<div class="spinner"></div><p>Adding data point...</p>';
        submitButton.disabled = true;
        
        try {
          // Prepare the data
          const data = {
            value: parseFloat(valueInput.value),
            label: labelInput.value,
            category: categorySelect.value
          };
          
          // Make the request
          const response = await fetch('/api/data', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
          });
          
          // Parse the response
          const result = await response.json();
          
          // Check if successful
          if (response.ok && result.success) {
            resultDiv.innerHTML = `
              <div class="status-line">
                <span class="success-icon">✓</span>
                <span>${result.message}</span>
              </div>
              <p>New data point added with ID: ${result.data.id}</p>
              <p>Value: ${result.data.value}, Label: ${result.data.label}, Category: ${result.data.category}</p>
              <p>Timestamp: ${new Date(result.data.timestamp).toLocaleString()}</p>
            `;
            
            // Reset form
            valueInput.value = '';
            labelInput.value = '';
            categorySelect.value = '';
            
            // Refresh data table
            fetchDataFromRestApi();
          } else {
            throw new Error(result.message || 'Error adding data point');
          }
        } catch (error) {
          resultDiv.innerHTML = `
            <div class="status-line">
              <span class="error-icon">✗</span>
              <span>Error adding data point</span>
            </div>
            <p>Error details: ${error.message}</p>
          `;
        } finally {
          submitButton.disabled = false;
        }
      }
      
      // Set up event listeners after page loads
      window.onload = function() {
        setTimeout(checkServerStatus, 1000);
        
        // Add event listener to the fetch data button
        const fetchButton = document.getElementById('fetch-data-btn');
        if (fetchButton) {
          fetchButton.addEventListener('click', fetchDataFromRestApi);
        }
        
        // Add event listener to the form
        const addDataForm = document.getElementById('add-data-form');
        if (addDataForm) {
          addDataForm.addEventListener('submit', addDataPoint);
        }
      };
    </script>
  </body>
</html>